import { useNavigate } from "react-router-dom";

function SvgStarBar({ idSuffix, rating = 0 }) {
  const clamped = Math.max(0, Math.min(5, Number(rating) || 0));
  const widthPercent = (clamped / 5) * 100;
  const clipId = `stars-clip-${String(idSuffix).replace(/\s+/g, "-")}`;
  return (
    <div className="flex items-center mt-3">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 184 37"
        style={{ width: "170px", height: "38px" }}
        aria-label={`별점 ${clamped}점 (최대 5점)`}
      >
        <defs>
          <clipPath id={clipId}>
            <path d="M17.5489 2.92705C17.8483 2.00574 19.1517 2.00574 19.4511 2.92705L22.429 12.0922C22.5629 12.5042 22.9468 12.7832 23.3801 12.7832H33.0169C33.9856 12.7832 34.3884 14.0228 33.6046 14.5922L25.8083 20.2566C25.4578 20.5112 25.3112 20.9626 25.445 21.3746L28.423 30.5398C28.7223 31.4611 27.6678 32.2272 26.8841 31.6578L19.0878 25.9934C18.7373 25.7388 18.2627 25.7388 17.9122 25.9934L10.1159 31.6578C9.33216 32.2272 8.27768 31.4611 8.57703 30.5398L11.555 21.3746C11.6888 20.9626 11.5422 20.5112 11.1917 20.2566L3.39535 14.5922C2.61164 14.0228 3.01442 12.7832 3.98314 12.7832H13.6199C14.0532 12.7832 14.4371 12.5042 14.571 12.0922L17.5489 2.92705Z" />
            <path d="M54.5489 2.92705C54.8483 2.00574 56.1517 2.00574 56.4511 2.92705L59.429 12.0922C59.5629 12.5042 59.9468 12.7832 60.3801 12.7832H70.0169C70.9856 12.7832 71.3884 14.0228 70.6046 14.5922L62.8083 20.2566C62.4578 20.5112 62.3112 20.9626 62.445 21.3746L65.423 30.5398C65.7223 31.4611 64.6678 32.2272 63.8841 31.6578L56.0878 25.9934C55.7373 25.7388 55.2627 25.7388 54.9122 25.9934L47.1159 31.6578C46.3322 32.2272 45.2777 31.4611 45.577 30.5398L48.555 21.3746C48.6888 20.9626 48.5422 20.5112 48.1917 20.2566L40.3954 14.5922C39.6116 14.0228 40.0144 12.7832 40.9831 12.7832H50.6199C51.0532 12.7832 51.4371 12.5042 51.571 12.0922L54.5489 2.92705Z" />
            <path d="M91.5489 2.92705C91.8483 2.00574 93.1517 2.00574 93.4511 2.92705L96.429 12.0922C96.5629 12.5042 96.9468 12.7832 97.3801 12.7832H107.017C107.986 12.7832 108.388 14.0228 107.605 14.5922L99.8083 20.2566C99.4578 20.5112 99.3112 20.9626 99.445 21.3746L102.423 30.5398C102.722 31.4611 101.668 32.2272 100.884 31.6578L93.0878 25.9934C92.7373 25.7388 92.2627 25.7388 91.9122 25.9934L84.1159 31.6578C83.3322 32.2272 82.2777 31.4611 82.577 30.5398L85.555 21.3746C85.6888 20.9626 85.5422 20.5112 85.1917 20.2566L77.3954 14.5922C76.6116 14.0228 77.0144 12.7832 77.9831 12.7832H87.6199C88.0532 12.7832 88.4371 12.5042 88.571 12.0922L91.5489 2.92705Z" />
            <path d="M128.549 2.92705C128.848 2.00574 130.152 2.00574 130.451 2.92705L133.429 12.0922C133.563 12.5042 133.947 12.7832 134.38 12.7832H144.017C144.986 12.7832 145.388 14.0228 144.605 14.5922L136.808 20.2566C136.458 20.5112 136.311 20.9626 136.445 21.3746L139.423 30.5398C139.722 31.4611 138.668 32.2272 137.884 31.6578L130.088 25.9934C129.737 25.7388 129.263 25.7388 128.912 25.9934L121.116 31.6578C120.332 32.2272 119.278 31.4611 119.577 30.5398L122.555 21.3746C122.689 20.9626 122.542 20.5112 122.192 20.2566L114.395 14.5922C113.612 14.0228 114.014 12.7832 114.983 12.7832H124.62C125.053 12.7832 125.437 12.5042 125.571 12.0922L128.549 2.92705Z" />
            <path d="M164.549 2.92705C164.848 2.00574 166.152 2.00574 166.451 2.92705L169.429 12.0922C169.563 12.5042 169.947 12.7832 170.38 12.7832H180.017C180.986 12.7832 181.388 14.0228 180.605 14.5922L172.808 20.2566C172.458 20.5112 172.311 20.9626 172.445 21.3746L175.423 30.5398C175.722 31.4611 174.668 32.2272 173.884 31.6578L166.088 25.9934C165.737 25.7388 165.263 25.7388 164.912 25.9934L157.116 31.6578C156.332 32.2272 155.278 31.4611 155.577 30.5398L158.555 21.3746C158.689 20.9626 158.542 20.5112 158.192 20.2566L150.395 14.5922C149.612 14.0228 150.014 12.7832 150.983 12.7832H160.62C161.053 12.7832 161.437 12.5042 161.571 12.0922L164.549 2.92705Z" />
          </clipPath>
        </defs>
        <g fill="#E5E7EB">
          <path d="M17.5489 2.92705C17.8483 2.00574 19.1517 2.00574 19.4511 2.92705L22.429 12.0922C22.5629 12.5042 22.9468 12.7832 23.3801 12.7832H33.0169C33.9856 12.7832 34.3884 14.0228 33.6046 14.5922L25.8083 20.2566C25.4578 20.5112 25.3112 20.9626 25.445 21.3746L28.423 30.5398C28.7223 31.4611 27.6678 32.2272 26.8841 31.6578L19.0878 25.9934C18.7373 25.7388 18.2627 25.7388 17.9122 25.9934L10.1159 31.6578C9.33216 32.2272 8.27768 31.4611 8.57703 30.5398L11.555 21.3746C11.6888 20.9626 11.5422 20.5112 11.1917 20.2566L3.39535 14.5922C2.61164 14.0228 3.01442 12.7832 3.98314 12.7832H13.6199C14.0532 12.7832 14.4371 12.5042 14.571 12.0922L17.5489 2.92705Z" />
          <path d="M54.5489 2.92705C54.8483 2.00574 56.1517 2.00574 56.4511 2.92705L59.429 12.0922C59.5629 12.5042 59.9468 12.7832 60.3801 12.7832H70.0169C70.9856 12.7832 71.3884 14.0228 70.6046 14.5922L62.8083 20.2566C62.4578 20.5112 62.3112 20.9626 62.445 21.3746L65.423 30.5398C65.7223 31.4611 64.6678 32.2272 63.8841 31.6578L56.0878 25.9934C55.7373 25.7388 55.2627 25.7388 54.9122 25.9934L47.1159 31.6578C46.3322 32.2272 45.2777 31.4611 45.577 30.5398L48.555 21.3746C48.6888 20.9626 48.5422 20.5112 48.1917 20.2566L40.3954 14.5922C39.6116 14.0228 40.0144 12.7832 40.9831 12.7832H50.6199C51.0532 12.7832 51.4371 12.5042 51.571 12.0922L54.5489 2.92705Z" />
          <path d="M91.5489 2.92705C91.8483 2.00574 93.1517 2.00574 93.4511 2.92705L96.429 12.0922C96.5629 12.5042 96.9468 12.7832 97.3801 12.7832H107.017C107.986 12.7832 108.388 14.0228 107.605 14.5922L99.8083 20.2566C99.4578 20.5112 99.3112 20.9626 99.445 21.3746L102.423 30.5398C102.722 31.4611 101.668 32.2272 100.884 31.6578L93.0878 25.9934C92.7373 25.7388 92.2627 25.7388 91.9122 25.9934L84.1159 31.6578C83.3322 32.2272 82.2777 31.4611 82.577 30.5398L85.555 21.3746C85.6888 20.9626 85.5422 20.5112 85.1917 20.2566L77.3954 14.5922C76.6116 14.0228 77.0144 12.7832 77.9831 12.7832H87.6199C88.0532 12.7832 88.4371 12.5042 88.571 12.0922L91.5489 2.92705Z" />
          <path d="M128.549 2.92705C128.848 2.00574 130.152 2.00574 130.451 2.92705L133.429 12.0922C133.563 12.5042 133.947 12.7832 134.38 12.7832H144.017C144.986 12.7832 145.388 14.0228 144.605 14.5922L136.808 20.2566C136.458 20.5112 136.311 20.9626 136.445 21.3746L139.423 30.5398C139.722 31.4611 138.668 32.2272 137.884 31.6578L130.088 25.9934C129.737 25.7388 129.263 25.7388 128.912 25.9934L121.116 31.6578C120.332 32.2272 119.278 31.4611 119.577 30.5398L122.555 21.3746C122.689 20.9626 122.542 20.5112 122.192 20.2566L114.395 14.5922C113.612 14.0228 114.014 12.7832 114.983 12.7832H124.62C125.053 12.7832 125.437 12.5042 125.571 12.0922L128.549 2.92705Z" />
          <path d="M164.549 2.92705C164.848 2.00574 166.152 2.00574 166.451 2.92705L169.429 12.0922C169.563 12.5042 169.947 12.7832 170.38 12.7832H180.017C180.986 12.7832 181.388 14.0228 180.605 14.5922L172.808 20.2566C172.458 20.5112 172.311 20.9626 172.445 21.3746L175.423 30.5398C175.722 31.4611 174.668 32.2272 173.884 31.6578L166.088 25.9934C165.737 25.7388 165.263 25.7388 164.912 25.9934L157.116 31.6578C156.332 32.2272 155.278 31.4611 155.577 30.5398L158.555 21.3746C158.689 20.9626 158.542 20.5112 158.192 20.2566L150.395 14.5922C149.612 14.0228 150.014 12.7832 150.983 12.7832H160.62C161.053 12.7832 161.437 12.5042 161.571 12.0922L164.549 2.92705Z" />
        </g>
        <g clipPath={`url(#${clipId})`}>
          <rect
            x="0"
            y="0"
            width={`${widthPercent}%`}
            height="100%"
            fill="#FF6C6F"
          />
        </g>
      </svg>
      <span className="ml-2 text-[18px] font-normal text-black">
        {clamped.toFixed(1)}
      </span>
    </div>
  );
}

export default function StoreGridList({ stores = [] }) {
  const navigate = useNavigate();

  const handleNavigate = (storeId) => {
    if (!storeId) return;
    navigate(`/store/${storeId}`);
  };

  if (!Array.isArray(stores) || stores.length === 0) {
    return null;
  }

  return (
    <>
      {stores.map((store) => {
        const name = store.name || "가게명";
        const address = store.address || "주소 정보 없음";
        const categories = Array.isArray(store.categories)
          ? store.categories.slice(0, 2)
          : [];
        const rating = store.rating ?? 0;
        const image = store.image || null;
        const isOpen = store.is_open;

        return (
          <div key={store.id || name} className="w-full">
            {/* 이미지 영역 */}
            <button
              type="button"
              onClick={() => handleNavigate(store.id)}
              className="w-full h-60 rounded-2xl bg-search-bg overflow-hidden cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-red-400"
            >
              {image ? (
                <img
                  src={image}
                  alt={name}
                  className="w-full h-full object-cover"
                  loading="lazy"
                  onError={(e) => {
                    e.currentTarget.style.display = "none";
                  }}
                />
              ) : null}
            </button>

            {/* 정보 영역 */}
            <div className="flex items-end mt-4 justify-between">
              <div>
                <button
                  type="button"
                  onClick={() => handleNavigate(store.id)}
                  className="block text-left text-black text-2xl font-semibold focus:outline-none hover:underline"
                >
                  {name}
                </button>
                <button
                  type="button"
                  onClick={() => handleNavigate(store.id)}
                  className="block text-left text-text text-base font-medium focus:outline-none hover:underline"
                >
                  {address}
                </button>
                <div className="flex gap-2 mt-2">
                  {categories.map((tag, idx) => (
                    <span
                      key={`${store.id}-tag-${idx}`}
                      className="flex px-3 h-6 bg-white rounded-3xl outline outline-2 outline-offset-[-1.94px] outline-red-400 justify-center items-center text-black text-xs font-semibold"
                    >
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>

              {typeof isOpen === "boolean" && (
                <div
                  className={`text-white text-xs font-medium min-w-16 h-7 px-[5px] py-1 rounded-3xl inline-flex justify-center items-center gap-1.5 ${
                    isOpen ? "bg-red-400" : "bg-gray-400"
                  }`}
                >
                  {isOpen ? "영업중" : "영업종료"}
                </div>
              )}
            </div>

            {/* 별점 */}
            <div className="flex justify-end">
              <SvgStarBar idSuffix={store.id || name} rating={rating} />
            </div>
          </div>
        );
      })}
    </>
  );
}
